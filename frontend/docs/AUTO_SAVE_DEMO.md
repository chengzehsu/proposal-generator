# 自動儲存功能演示指南

## 快速測試

### 1. 正常自動儲存

**步驟**:
1. 開啟標書編輯器
2. 編輯內容
3. 等待 2 秒

**預期結果**:
- 狀態顯示「儲存中...」
- 2-3 秒後顯示「已儲存 剛剛」
- 圖示變為綠色 ✓

---

### 2. 離線模式測試

**步驟**:
1. 開啟標書編輯器
2. 打開瀏覽器開發工具 (F12)
3. 切換到 Network 標籤
4. 選擇「Offline」模式
5. 編輯內容

**預期結果**:
- 頂部顯示黃色「離線模式」標籤
- 顯示警告訊息: "目前處於離線模式，內容將儲存在本機"
- 狀態顯示「離線編輯 (本地備份)」
- 圖示變為 Wi-Fi 關閉圖示

**驗證本地備份**:
```javascript
// 在瀏覽器控制台執行
localStorage.getItem('proposal_draft_[標書ID]')
// 應該看到最新的編輯內容
```

---

### 3. 網路恢復自動同步

**步驟**:
1. 繼續上一個測試
2. 在開發工具中將網路設為「Online」

**預期結果**:
- 離線標籤消失
- 1 秒後自動觸發儲存
- 狀態顯示「儲存中...」→「已儲存」
- LocalStorage 備份被清除

**驗證備份清除**:
```javascript
// 在瀏覽器控制台執行
localStorage.getItem('proposal_draft_[標書ID]')
// 應該返回 null (已清除)
```

---

### 4. 儲存失敗處理

**步驟**:
1. 打開開發工具 Network 標籤
2. 右鍵點擊 API 請求
3. 選擇「Block request URL」或使用 Offline 模式
4. 編輯內容

**預期結果**:
- 顯示紅色錯誤警告: "自動儲存失敗: [錯誤訊息]"
- 狀態顯示「儲存失敗」
- 圖示變為紅色錯誤圖示
- 內容已備份到 LocalStorage

---

### 5. 草稿恢復測試

**步驟**:
1. 編輯內容但不要等待自動儲存完成
2. 立即關閉瀏覽器或刷新頁面 (會觸發 beforeunload 確認)
3. 強制關閉或確認離開
4. 重新開啟同一標書

**預期結果**:
- 顯示確認對話框: "發現本地儲存的草稿，是否恢復？"
- 點擊「確定」: 內容恢復為本地草稿
- 點擊「取消」: 載入伺服器版本，本地草稿被清除

---

### 6. 離開頁面確認

**步驟**:
1. 編輯內容
2. 嘗試關閉瀏覽器標籤或重新整理頁面

**預期結果**:
- 瀏覽器顯示確認對話框
- 訊息: "您有未儲存的變更，確定要離開嗎？" (注意: 現代瀏覽器可能顯示預設訊息)
- 點擊「取消」: 留在頁面
- 點擊「確定」: 離開頁面

---

### 7. 手動儲存

**步驟**:
1. 編輯內容
2. 點擊「手動儲存」按鈕

**預期結果**:
- 立即觸發儲存 (不等待防抖)
- 狀態顯示「儲存中...」→「已儲存」
- Toast 通知: "儲存成功"

---

## 視覺狀態參考

### 儲存狀態圖示

| 狀態 | 圖示 | 顏色 | 文字 |
|------|------|------|------|
| 閒置 | - | - | - |
| 儲存中 | ⟳ (旋轉) | 藍色 | 儲存中... |
| 已儲存 | ✓ | 綠色 | 已儲存 剛剛 |
| 錯誤 | ✕ | 紅色 | 儲存失敗 |
| 離線 | 📶 關閉 | 橙色 | 離線編輯 |

### 時間格式範例

- `剛剛` - 小於 1 分鐘
- `5 分鐘前` - 1-60 分鐘
- `2 小時前` - 1-24 小時
- `3 天前` - 1-7 天
- `2024/10/05 14:30` - 超過 7 天

---

## 開發工具技巧

### 模擬網路狀態

**Chrome DevTools**:
1. F12 → Network 標籤
2. 下拉選單: Online / Slow 3G / Offline

**控制台模擬**:
```javascript
// 模擬離線
window.dispatchEvent(new Event('offline'))

// 模擬上線
window.dispatchEvent(new Event('online'))
```

### 檢查 LocalStorage

```javascript
// 查看所有草稿
Object.keys(localStorage)
  .filter(k => k.startsWith('proposal_draft_'))
  .forEach(k => console.log(k, localStorage.getItem(k)))

// 清除所有草稿
Object.keys(localStorage)
  .filter(k => k.startsWith('proposal_draft_'))
  .forEach(k => localStorage.removeItem(k))
```

### 模擬儲存錯誤

在開發環境修改 API 呼叫:
```typescript
const mockError = true

onSave: async (content) => {
  if (mockError) {
    throw new Error('模擬儲存失敗')
  }
  await api.updateProposal(id, content)
}
```

---

## 測試檢查清單

- [ ] 正常自動儲存 (2 秒防抖)
- [ ] 離線時顯示警告標籤
- [ ] 離線時內容儲存到 LocalStorage
- [ ] 網路恢復後自動同步
- [ ] 同步成功後清除 LocalStorage
- [ ] 儲存失敗時顯示錯誤訊息
- [ ] 儲存失敗時備份到 LocalStorage
- [ ] 重新載入時提示恢復草稿
- [ ] 恢復草稿功能正常
- [ ] 放棄草稿時清除 LocalStorage
- [ ] 有未儲存變更時離開頁面會確認
- [ ] 手動儲存立即執行
- [ ] 狀態圖示正確顯示
- [ ] 相對時間格式正確
- [ ] 多視窗同步 (同一瀏覽器)

---

## 常見問題排查

### Q: 為什麼沒有自動儲存？

**檢查**:
1. 內容是否真的有變更？
2. 是否等待了 2 秒？
3. 上一次儲存是否仍在進行中？
4. 開發工具 Console 有無錯誤？

### Q: 離線模式沒有顯示？

**檢查**:
1. 瀏覽器是否真的離線？(檢查 `navigator.onLine`)
2. 網路模擬是否正確設定？
3. 事件監聽器是否正常運作？

### Q: 草稿沒有恢復？

**檢查**:
1. LocalStorage 是否有資料？
2. 草稿內容是否與伺服器版本相同？(相同則不提示)
3. 瀏覽器是否在私密模式？(私密模式關閉後清空)

### Q: 離開確認沒有觸發？

**檢查**:
1. `hasUnsavedChanges` 是否為 true？
2. 是否在正確的生命週期觸發？
3. 某些瀏覽器可能不支援自訂訊息

---

## 截圖示範 (UI 參考)

### 正常狀態
```
┌─────────────────────────────────────────┐
│ 標書編輯器                               │
│ ✓ 已儲存 剛剛      [版本歷史] [手動儲存] │
└─────────────────────────────────────────┘
```

### 離線模式
```
┌─────────────────────────────────────────┐
│ 標書編輯器                               │
│ [離線模式] 📶 離線編輯  [版本歷史] [儲存] │
└─────────────────────────────────────────┘
│ ⚠ 目前處於離線模式，內容將儲存在本機...  │
└─────────────────────────────────────────┘
```

### 儲存錯誤
```
┌─────────────────────────────────────────┐
│ 標書編輯器                               │
│ ✕ 儲存失敗: Network error               │
└─────────────────────────────────────────┘
│ ✕ 自動儲存失敗: Network error...         │
└─────────────────────────────────────────┘
```

---

**演示指南版本**: 1.0.0
**建議測試時間**: 15-20 分鐘

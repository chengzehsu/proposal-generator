// Prisma Schema for 智能標書產生器系統
// SQLite 兼容版本

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 使用者和權限系統
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String?
  is_active   Boolean  @default(true)
  role        UserRole @default(USER)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  last_login  DateTime?

  // 關聯關係
  companies   Company[]
  proposals   Proposal[]
  audit_logs  AuditLog[]

  @@map("users")
}

// 公司基本資料
model Company {
  id                String   @id @default(cuid())
  user_id           String
  name              String
  tax_id            String   @unique
  capital           String?  // 改為 String 存儲數字
  established_date  DateTime?
  phone             String?
  email             String?
  website           String?
  address           String?
  postal_code       String?
  industry          String?
  employee_count    Int?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  version           Int      @default(1)

  // 關聯關係
  user             User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  company_profile  CompanyProfile?
  team_members     TeamMember[]
  projects         Project[]
  awards           Award[]
  capabilities     Capability[]
  milestones       CompanyMilestone[]
  proposals        Proposal[]

  @@map("companies")
}

// 公司詳細簡介（版本控制）
model CompanyProfile {
  id                 String   @id @default(cuid())
  company_id         String   @unique
  version_name       String
  vision             String?
  mission            String?
  core_values        String?
  business_scope     String
  description_full   String
  description_medium String?
  description_short  String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("company_profiles")
}

// 團隊成員
model TeamMember {
  id           String    @id @default(cuid())
  company_id   String
  name         String
  position     String
  email        String?
  phone        String?
  department   String?
  education    String?
  experience   String?
  expertise    String?
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  deleted_at   DateTime?

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("team_members")
}

// 專案實績
model Project {
  id           String    @id @default(cuid())
  company_id   String
  name         String
  client_name  String?
  start_date   DateTime?
  end_date     DateTime?
  amount       String?   // 改為 String 存儲金額
  currency     String?
  scale        String?
  description  String
  achievements String?
  tags         String?   // 改為單一字符串，JSON 格式存儲標籤
  is_public    Boolean   @default(true)
  attachments  String?   // 改為 String 存儲 JSON
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("projects")
}

// 獲獎紀錄
model Award {
  id          String    @id @default(cuid())
  company_id  String
  title       String
  issuer      String
  award_date  DateTime?
  description String?
  award_type  AwardType
  amount      String?   // 改為 String 存儲金額
  is_public   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("awards")
}

// 公司里程碑
model CompanyMilestone {
  id             String   @id @default(cuid())
  company_id     String
  milestone_date DateTime
  title          String
  description    String?
  milestone_type String?
  importance     Int      // 1-5
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("company_milestones")
}

// 公司技術能力
model Capability {
  id               String   @id @default(cuid())
  company_id       String
  name             String
  category         String
  description      String?
  proficiency      String?
  related_projects String?  // 改為 String 存儲項目 ID 列表
  certifications   String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // 關聯關係
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("capabilities")
}

// 標書範本系統
model ProposalTemplate {
  id           String            @id @default(cuid())
  name         String
  description  String?
  category     String
  is_default   Boolean           @default(false)
  is_active    Boolean           @default(true)
  version      String            @default("1.0")
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt

  // 關聯關係
  sections     TemplateSection[]
  proposals    Proposal[]

  @@map("proposal_templates")
}

// 範本章節
model TemplateSection {
  id              String                @id @default(cuid())
  template_id     String
  name            String
  description     String?
  display_order   Int
  is_required     Boolean               @default(true)
  section_type    SectionType
  content_hint    String?
  created_at      DateTime              @default(now())
  updated_at      DateTime              @updatedAt

  // 關聯關係
  template        ProposalTemplate      @relation(fields: [template_id], references: [id], onDelete: Cascade)
  proposal_sections ProposalSection[]

  @@map("template_sections")
}

// 標書項目
model Proposal {
  id           String    @id @default(cuid())
  user_id      String
  company_id   String
  template_id  String?
  title        String
  client_name  String?
  deadline     DateTime?
  status       ProposalStatus @default(DRAFT)
  total_pages  Int?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  version      Int       @default(1)

  // 關聯關係
  user         User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  company      Company            @relation(fields: [company_id], references: [id], onDelete: Cascade)
  template     ProposalTemplate?  @relation(fields: [template_id], references: [id])
  sections     ProposalSection[]
  versions     ProposalVersion[]

  @@map("proposals")
}

// 標書章節內容
model ProposalSection {
  id                  String           @id @default(cuid())
  proposal_id         String
  template_section_id String?
  name                String
  content             String           // 存儲為富文本 JSON
  display_order       Int
  word_count          Int?
  is_completed        Boolean          @default(false)
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt

  // 關聯關係
  proposal         Proposal         @relation(fields: [proposal_id], references: [id], onDelete: Cascade)
  template_section TemplateSection? @relation(fields: [template_section_id], references: [id])

  @@map("proposal_sections")
}

// 標書版本管理
model ProposalVersion {
  id           String   @id @default(cuid())
  proposal_id  String
  version      Int
  content      String   // 完整標書內容的 JSON
  changes      String?  // 變更記錄
  created_by   String
  created_at   DateTime @default(now())

  // 關聯關係
  proposal Proposal @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@unique([proposal_id, version])
  @@map("proposal_versions")
}

// 審計日誌
model AuditLog {
  id         String   @id @default(cuid())
  user_id    String?
  action     String
  table_name String
  record_id  String?
  old_values String?  // JSON
  new_values String?  // JSON
  created_at DateTime @default(now())
  ip_address String?
  user_agent String?

  // 關聯關係
  user User? @relation(fields: [user_id], references: [id])

  @@map("audit_logs")
}

// 枚舉定義
enum UserRole {
  ADMIN
  USER
}

enum AwardType {
  GOVERNMENT
  INDUSTRY
  CERTIFICATION
  PATENT
  OTHER
}

enum SectionType {
  COMPANY_PROFILE
  TECHNICAL_CAPABILITY
  PROJECT_EXPERIENCE
  TEAM_INTRODUCTION
  PROPOSAL_CONTENT
  BUDGET_PLAN
  TIMELINE
  OTHER
}

enum ProposalStatus {
  DRAFT
  IN_REVIEW
  COMPLETED
  SUBMITTED
  ARCHIVED
}